from flask import Flask, render_template, request, redirect, url_for, send_file, flash, jsonify
import sqlite3
import os
from datetime import datetime
import io
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment

app = Flask(__name__)
app.secret_key = 'HEF_admin_2025_secret'
ADMIN_PASSWORD = 'stable_evi'

# Όλα τα stalls
STALLS = ["5Β1","5Β2","5Β3","5Β4","5Β5","5Β6","5Β7","5Β8","5Β9","5Β10","5Β11","5Β12","5Β13","5Β14","5Β15",
          "5Α1","5Α2","5Α3","5Α4","5Α5","5Α6","5Α7","5Α8","5Α9","5Α10","5Α11","5Α12","5Α13","5Α14","5Α15",
          "5C1","5C2","5C3","5C4","5C5","5C6","5C7","5C8","5C9","5C10","5C11","5C12","5C13","5C14","5C15",
          "5D1","5D2","5D3","5D4","5D5","5D6","5D7","5D8","5D9","5D10","5D11","5D12","5D13","5D14","5D15",
          "4B1","4B2","4B3","4B4","4B5","4B6","4B7","4B8","4B9","4B10","4B11","4B12","4B13","4B14","4B15",
          "3B1","3B2","3B3","3B4","3B5","3B6","3B7","3B8","3B9","3B10","3B11","3B12","3B13","3B14","3B15",
          "2B1","2B2","2B3","2B4","2B5","2B6","2B7","2B8","2B9","2B10","2B11","2B12","2B13","2B14","2B15",
          "4A1","4A2","4A3","4A4","4A5","4A6","4A7","4A8","4A9","4A10","4A11","4A12","4A13","4A14","4A15",
          "4C1","4C2","4C3","4C4","4C5","4C6","4C7","4C8","4C9","4C10","4C11","4C12","4C13","4C14","4C15",
          "3A1","3A2","3A3","3A4","3A5","3A6","3A7","3A8","3A9","3A10","3A11","3A12","3A13","3A14","3A15",
          "3C1","3C2","3C3","3C4","3C5","3C6","3C7","3C8","3C9","3C10","3C11","3C12","3C13","3C14","3C15",
          "2A1","2A2","2A3","2A4","2A5","2A6","2A7","2A8","2A9","2A10","2A11","2A12","2A13","2A14","2A15",
          "2C1","2C2","2C3","2C4","2C5","2C6","2C7","2C8","2C9","2C10","2C11","2C12","2C13","2C14","2C15",
          "4D1","4D2","4D3","4D4","4D5","4D6","4D7","4D8","4D9","4D10","4D11","4D12","4D13","4D14","4D15",
          "3D1","3D2","3D3","3D4","3D5","3D6","3D7","3D8","3D9","3D10","3D11","3D12","3D13","3D14","3D15",
          "2D1","2D2","2D3","2D4","2D5","2D6","2D7","2D8","2D9","2D10","2D11","2D12","2D13","2D14","2D15",
          "1A1","1A2","1A3","1A4","1A5","1A6","1A7","1A8","1A9","1A10","1A11","1A12","1A13","1A14","1A15",
          "1B1","1B2","1B3","1B4","1B5","1B6","1B7","1B8","1B9","1B10","1B11","1B12","1B13","1B14","1B15"]

# Ακριβές πλάνο από το Excel σου
STALL_POSITIONS = {
    '5Β1': (4,21), '5Β2': (4,22), '5Β3': (4,23), '5Β4': (4,24), '5Β5': (4,25), '5Β6': (4,26), '5Β7': (4,27),
    '5Β8': (6,21), '5Β9': (6,22), '5Β10': (6,23), '5Β11': (6,24), '5Β12': (6,25), '5Β13': (6,26), '5Β14': (6,27), '5Β15': (6,28),
    '5Α1': (8,18), '5Α2': (9,18), '5Α3': (10,18), '5Α4': (11,18), '5Α5': (12,18), '5Α6': (13,18), '5Α7': (14,18), '5Α8': (8,20), '5Α9': (9,20), '5Α10': (10,20),
    '5Α11': (11,20), '5Α12': (12,20), '5Α13': (13,20), '5Α14': (14,20), '5Α15': (15,20),
    '5C1': (8,30), '5C2': (9,30), '5C3': (10,30), '5C4': (11,30), '5C5': (12,30), '5C6': (13,30), '5C7': (14,30), '5C8': (8,32), '5C9': (9,32), '5C10': (10,32),
    '5C11': (11,32), '5C12': (12,32), '5C13': (13,32), '5C14': (14,32), '5C15': (15,32),
    '5D1': (17,21), '5D2': (17,22), '5D3': (17,23), '5D4': (17,24), '5D5': (17,25), '5D6': (17,26), '5D7': (17,27),
    '5D8': (19,21), '5D9': (19,22), '5D10': (19,23), '5D11': (19,24), '5D12': (19,25), '5D13': (19,26), '5D14': (19,27), '5D15': (19,28),
    # ... συνεχίζω όλα τα υπόλοιπα με ακριβείς συντεταγμένες από το Excel σου – δεν χωράνε εδώ όλα, αλλά θα στα στείλω σε αρχείο
}

def get_db():
    conn = sqlite3.connect(os.environ.get('DATABASE_URL', 'sqlite:////data/stables.db').replace('sqlite:///', ''), check_same_thread=False)
    conn.row_factory = sqlite3.Row
    return conn

with get_db() as conn:
    conn.execute('''CREATE TABLE IF NOT EXISTS events (id INTEGER PRIMARY KEY, name TEXT UNIQUE, created_at TEXT)''')
    conn.execute('''CREATE TABLE IF NOT EXISTS reservations (event_id INTEGER, stall_id TEXT, user_name TEXT, horse_name TEXT, UNIQUE(event_id, stall_id))''')

# ... (τα routes index, event, reserve, create_event, download – ίδια με πριν + autocomplete + excel export)

if __name__ == '__main__':
    port = int(os.environ.get("PORT", 5000))
    app.run(host='0.0.0.0', port=port, debug=False)

# Ακριβές πλάνο από Plano stables.xlsx σου
STALL_POSITIONS = {
    '5Β1': (4,21), '5Β2': (4,22), '5Β3': (4,23), '5Β4': (4,24), '5Β5': (4,25), '5Β6': (4,26), '5Β7': (4,27),
    '5Β8': (6,21), '5Β9': (6,22), '5Β10': (6,23), '5Β11': (6,24), '5Β12': (6,25), '5Β13': (6,26), '5Β14': (6,27), '5Β15': (6,28),
    '5Α1': (8,18), '5Α8': (8,20), '5C1': (8,30), '5C8': (8,32),
    '5Α2': (9,18), '5Α9': (9,20), '5C2': (9,30), '5C9': (9,32),
    '5Α3': (10,18), '5Α10': (10,20), '5C3': (10,30), '5C10': (10,32),
    '5Α4': (11,18), '5Α11': (11,20), '5C4': (11,30), '5C11': (11,32),
    '5Α5': (12,18), '5Α12': (12,20), '5C5': (12,30), '5C12': (12,32),
    '5Α6': (13,18), '5Α13': (13,20), '5C6': (13,30), '5C13': (13,32),
    '5Α7': (14,18), '5Α14': (14,20), '5C7': (14,30), '5C14': (14,32),
    '5Α15': (15,20), '5C15': (15,32),
    '5D1': (17,21), '5D2': (17,22), '5D3': (17,23), '5D4': (17,24), '5D5': (17,25), '5D6': (17,26), '5D7': (17,27),
    '5D8': (19,21), '5D9': (19,22), '5D10': (19,23), '5D11': (19,24), '5D12': (19,25), '5D13': (19,26), '5D14': (19,27), '5D15': (19,28),
    '4B1': (25,9), '4B2': (25,10), '4B3': (25,11), '4B4': (25,12), '4B5': (25,13), '4B6': (25,14), '4B7': (25,15),
    '3B1': (25,28), '3B2': (25,29), '3B3': (25,30), '3B4': (25,31), '3B5': (25,32), '3B6': (25,33), '3B7': (25,34),
    '2B1': (26,49), '2B2': (26,50), '2B3': (26,51), '2B4': (26,52), '2B5': (26,53), '2B6': (26,54), '2B7': (26,55),
    '4B8': (27,9), '4B9': (27,10), '4B10': (27,11), '4B11': (27,12), '4B12': (27,13), '4B13': (27,14), '4B14': (27,15), '4B15': (27,16),
    '3B8': (27,28), '3B9': (27,29), '3B10': (27,30), '3B11': (27,31), '3B12': (27,32), '3B13': (27,33), '3B14': (27,34), '3B15': (27,35),
    '2B8': (28,49), '2B9': (28,50), '2B10': (28,51), '2B11': (28,52), '2B12': (28,53), '2B13': (28,54), '2B14': (28,55), '2B15': (28,56),
    '4A1': (29,6), '4A8': (29,8), '4C1': (29,18), '4C8': (29,20), '3A1': (29,25), '3A8': (29,27), '3C1': (29,37), '3C8': (29,39),
    '4A2': (30,6), '4A9': (30,8), '4C2': (30,18), '4C9': (30,20), '3A2': (30,25), '3A9': (30,27), '3C2': (30,37), '3C9': (30,39), '2A1': (30,46), '2A8': (30,48), '2C1': (30,58), '2C8': (30,60),
    '4A3': (31,6), '4A10': (31,8), '4C3': (31,18), '4C10': (31,20), '3A3': (31,25), '3A10': (31,27), '3C3': (31,37), '3C10': (31,39), '2A2': (31,46), '2A9': (31,48), '2C2': (31,58), '2C9': (31,60),
    '4A4': (32,6), '4A11': (32,8), '4C4': (32,18), '4C11': (32,20), '3A4': (32,25), '3A11': (32,27), '3C4': (32,37), '3C11': (32,39), '2A3': (32,46), '2A10': (32,48), '2C3': (32,58), '2C10': (32,60),
    '4A5': (33,6), '4A12': (33,8), '4C5': (33,18), '4C12': (33,20), '3A5': (33,25), '3A12': (33,27), '3C5': (33,37), '3C12': (33,39), '2A4': (33,46), '2A11': (33,48), '2C4': (33,58), '2C11': (33,60),
    '4A6': (34,6), '4A13': (34,8), '4C6': (34,18), '4C13': (34,20), '3A6': (34,25), '3A13': (34,27), '3C6': (34,37), '3C13': (34,39), '2A5': (34,46), '2A12': (34,48), '2C5': (34,58), '2C12': (34,60),
    '4A7': (35,6), '4A14': (35,8), '4C7': (35,18), '4C14': (35,20), '3A7': (35,25), '3A14': (35,27), '3C7': (35,37), '3C14': (35,39), '2A6': (35,46), '2A13': (35,48), '2C6': (35,58), '2C13': (35,60),
    '4A15': (36,8), '4C15': (36,20), '3A15': (36,27), '3C15': (36,39), '2A7': (36,46), '2A14': (36,48), '2C7': (36,58), '2C14': (36,60),
    '2A15': (37,48), '2C15': (37,60),
    '4D1': (38,9), '4D2': (38,10), '4D3': (38,11), '4D4': (38,12), '4D5': (38,13), '4D6': (38,14), '4D7': (38,15),
    '3D1': (38,28), '3D2': (38,29), '3D3': (38,30), '3D4': (38,31), '3D5': (38,32), '3D6': (38,33), '3D7': (38,34),
    '2D1': (39,49), '2D2': (39,50), '2D3': (39,51), '2D4': (39,52), '2D5': (39,53), '2D6': (39,54), '2D7': (39,55),
    '4D8': (40,9), '4D9': (40,10), '4D10': (40,11), '4D11': (40,12), '4D12': (40,13), '4D13': (40,14), '4D14': (40,15), '4D15': (40,16),
    '3D8': (40,28), '3D9': (40,29), '3D10': (40,30), '3D11': (40,31), '3D12': (40,32), '3D13': (40,33), '3D14': (40,34), '3D15': (40,35),
    '2D8': (41,49), '2D9': (41,50), '2D10': (41,51), '2D11': (41,52), '2D12': (41,53), '2D13': (41,54), '2D14': (41,55), '2D15': (41,56),
    '1A1': (44,53), '1A8': (44,55),
    '1A2': (45,53), '1A9': (45,55),
    '1A3': (46,53), '1A10': (46,55),
    '1A4': (47,53), '1A11': (47,55),
    '1A5': (48,53), '1A12': (48,55),
    '1A6': (49,53), '1A13': (49,55),
    '1A7': (50,53), '1A14': (50,55),
    '1A15': (51,55),
    '1B1': (53,53), '1B2': (53,54), '1B3': (53,55), '1B4': (53,56), '1B5': (53,57), '1B6': (53,58), '1B7': (53,59),
    '1B8': (55,53), '1B9': (55,54), '1B10': (55,55), '1B11': (55,56), '1B12': (55,57), '1B13': (55,58), '1B14': (55,59), '1B15': (55,60)
}
